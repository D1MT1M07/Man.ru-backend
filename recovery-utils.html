<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—Ç–∏–ª–∏—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è - Man.ru</title>
    <link rel="stylesheet" href="modern.css">
    <style>
        .recovery-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .recovery-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #4a9eff;
        }
        .recovery-section h3 {
            margin-top: 0;
            color: #333;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: 600;
            color: #666;
        }
        .info-value {
            color: #333;
            word-break: break-all;
        }
        .btn {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover {
            background: #2d7ed8;
        }
        .btn-danger {
            background: #ff6b6b;
        }
        .btn-danger:hover {
            background: #e63946;
        }
        .btn-success {
            background: #4caf50;
        }
        .btn-success:hover {
            background: #45a049;
        }
        .status-good {
            color: #4caf50;
            font-weight: 600;
        }
        .status-bad {
            color: #ff6b6b;
            font-weight: 600;
        }
        .status-warning {
            color: #ff9800;
            font-weight: 600;
        }
        .console-output {
            background: #222;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .user-item {
            padding: 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header__container">
            <h1>Man.ru</h1>
            <a href="index.html" style="color: #4a9eff; text-decoration: none;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </div>
    </header>

    <main class="main-container">
        <div class="recovery-container">
            <h1 style="text-align: center; margin-top: 0;">üîß –£—Ç–∏–ª–∏—Ç–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è</h1>
            
            <!-- –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
            <div class="recovery-section">
                <h3>üë§ –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                <div id="currentUserInfo">
                    <p style="color: #999;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="recovery-section">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div id="statistics">
                    <p style="color: #999;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>

            <!-- –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
            <div class="recovery-section">
                <h3>üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                <div id="usersList" class="user-list">
                    <p style="color: #999;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>

            <!-- –û–ø–µ—Ä–∞—Ü–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è -->
            <div class="recovery-section">
                <h3>üî® –û–ø–µ—Ä–∞—Ü–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</h3>
                <p style="color: #666; margin-bottom: 15px;">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏:</p>
                <button class="btn btn-success" onclick="recoverCurrentUserProfile()">‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å</button>
                <button class="btn btn-success" onclick="recoverAllProfiles()">üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ—Ñ–∏–ª–∏</button>
                <button class="btn btn-success" onclick="syncUserEmails()">üîó –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å email –∞–≤—Ç–æ—Ä–æ–≤</button>
                <button class="btn btn-warning" onclick="window.authManager.migrateUserData()">‚öôÔ∏è –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö</button>
                <div id="operationOutput" class="console-output" style="display: none;"></div>
            </div>

            <!-- –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
            <div class="recovery-section">
                <h3>‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏</h3>
                <button class="btn" onclick="checkDataIntegrity()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <div id="integrityReport" style="margin-top: 15px;"></div>
            </div>
        </div>
    </main>

    <script src="auth-script.js"></script>
    <script>
        function showCurrentUser() {
            const currentUser = JSON.parse(localStorage.getItem('man_ru_current_user'));
            const container = document.getElementById('currentUserInfo');
            
            if (!currentUser) {
                container.innerHTML = '<p class="status-bad">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</p>';
                return;
            }

            const users = JSON.parse(localStorage.getItem('man_ru_users')) || [];
            const userInList = users.find(u => u.email === currentUser.email);

            container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">ID:</span>
                    <span class="info-value">${currentUser.id}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–ò–º—è:</span>
                    <span class="info-value">${currentUser.name}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span class="info-value">${currentUser.email}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–ê–≤–∞—Ç–∞—Ä–∫–∞:</span>
                    <span class="info-value">${currentUser.avatar || 'üë§'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ñ–∏–ª—è:</span>
                    <span class="info-value">${userInList ? '<span class="status-good">‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î</span>' : '<span class="status-warning">‚ö†Ô∏è –ü–æ—Ç–µ—Ä—è–Ω, –Ω—É–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</span>'}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤:</span>
                    <span class="info-value">${(currentUser.followers || []).length}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–ü–æ–¥–ø–∏—Å–æ–∫:</span>
                    <span class="info-value">${(currentUser.following || []).length}</span>
                </div>
            `;
        }

        function showStatistics() {
            const users = JSON.parse(localStorage.getItem('man_ru_users')) || [];
            const articles = JSON.parse(localStorage.getItem('man_ru_articles')) || [];
            const posts = JSON.parse(localStorage.getItem('man_ru_forum_posts')) || [];
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∞–≤—Ç–æ—Ä–æ–≤ –±–µ–∑ –ø—Ä–æ—Ñ–∏–ª–µ–π
            const authorsInArticles = new Set(articles.map(a => a.authorEmail).filter(Boolean));
            const authorsInPosts = new Set(posts.map(p => p.authorEmail).filter(Boolean));
            const allAuthors = new Set([...authorsInArticles, ...authorsInPosts]);
            
            const authorsWithoutProfiles = Array.from(allAuthors).filter(email => !users.find(u => u.email === email));

            const container = document.getElementById('statistics');
            container.innerHTML = `
                <div class="info-row">
                    <span class="info-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</span>
                    <span class="info-value">${users.length}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–°—Ç–∞—Ç–µ–π:</span>
                    <span class="info-value">${articles.length}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–ü–æ—Å—Ç–æ–≤ –Ω–∞ —Ñ–æ—Ä—É–º–µ:</span>
                    <span class="info-value">${posts.length}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∞–≤—Ç–æ—Ä–æ–≤:</span>
                    <span class="info-value">${allAuthors.size}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">–ê–≤—Ç–æ—Ä–æ–≤ –±–µ–∑ –ø—Ä–æ—Ñ–∏–ª–µ–π:</span>
                    <span class="info-value">${authorsWithoutProfiles.length > 0 ? `<span class="status-warning">${authorsWithoutProfiles.length}</span>` : `<span class="status-good">0</span>`}</span>
                </div>
            `;
        }

        function showAllUsers() {
            const users = JSON.parse(localStorage.getItem('man_ru_users')) || [];
            const container = document.getElementById('usersList');
            
            if (users.length === 0) {
                container.innerHTML = '<p class="status-bad">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ë–î</p>';
                return;
            }

            container.innerHTML = users.map(user => `
                <div class="user-item">
                    <strong>${user.avatar || 'üë§'} ${user.name}</strong>
                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                        üìß ${user.email}<br>
                        üÜî ${user.id}<br>
                        üë• –ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤: ${(user.followers || []).length}, –ü–æ–¥–ø–∏—Å–æ–∫: ${(user.following || []).length}
                    </div>
                </div>
            `).join('');
        }

        function log(message) {
            const output = document.getElementById('operationOutput');
            output.style.display = 'block';
            output.innerHTML += message + '<br>';
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            document.getElementById('operationOutput').innerHTML = '';
        }

        function recoverCurrentUserProfile() {
            clearLog();
            log('üîç –ù–∞—á–∏–Ω–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è...');
            
            if (authManager && authManager.recoverUserProfile()) {
                log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
                log('üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É...');
                setTimeout(() => location.reload(), 1000);
            } else {
                log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å');
            }
        }

        function checkDataIntegrity() {
            const users = JSON.parse(localStorage.getItem('man_ru_users')) || [];
            const articles = JSON.parse(localStorage.getItem('man_ru_articles')) || [];
            const posts = JSON.parse(localStorage.getItem('man_ru_forum_posts')) || [];
            
            const report = document.getElementById('integrityReport');
            let issues = [];

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            users.forEach(user => {
                if (!user.followers) issues.push(`‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.name}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ followers`);
                if (!user.following) issues.push(`‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.name}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª–µ following`);
                if (!user.avatar) issues.push(`‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.name}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∞–≤–∞—Ç–∞—Ä–∫–∞`);
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—å–∏
            articles.forEach(article => {
                if (!article.authorEmail) issues.push(`‚ö†Ô∏è –°—Ç–∞—Ç—å—è "${article.title}": –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç authorEmail`);
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å—Ç—ã
            posts.forEach(post => {
                if (!post.authorEmail) issues.push(`‚ö†Ô∏è –ü–æ—Å—Ç "${post.title}": –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç authorEmail`);
            });

            if (issues.length === 0) {
                report.innerHTML = '<p class="status-good">‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ü–µ–ª—ã –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã!</p>';
            } else {
                report.innerHTML = '<div class="status-warning">‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</div>' +
                    issues.map(issue => `<p style="margin: 5px 0; color: #ff9800;">‚Ä¢ ${issue}</p>`).join('');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                showCurrentUser();
                showStatistics();
                showAllUsers();
            }, 500);
        });
    </script>
</body>
</html>
